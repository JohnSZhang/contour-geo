<link rel="stylesheet" href="http://forio.com/tools/contour/contour.min.css">

<script src="http://d3js.org/d3.v3.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.js"></script>
<script src="./../../../../dist/contour.js"></script>
<script src="./data/CAinflow.js"></script>
<script src="./data/statePop.js"></script>
<script src="./data/weather.js"></script>
<script src="./../../../../dist/contour.geo.min.js"></script>
<script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
<link href="./demo.css" rel="stylesheet" type="text/css">
<div class="myBivariateMap"></div>
<script>

// map the population flow number to a color class
var flowPerPop = {};
var stateKeys = _.keys(window.demo.USpop);
_.each(stateKeys, function(key){
  var outFlowPerPop = window.demo.CAInflow[key] / window.demo.USpop[key] * 10000;
  flowPerPop[key] = outFlowPerPop;
})

var maxFlowPerKey = _.max(_.keys(flowPerPop), function(state){
  return flowPerPop[state];
});
var maxPerFlow = flowPerPop[maxFlowPerKey];

var popColorScale = d3.scale.quantize()
  .domain([0, maxPerFlow])
  .range(d3.range(9)
  .map(function(i) { return i; }));

var minWeatherKey = _.min(_.keys(window.demo.weather), function(state){
  return window.demo.weather[state];
});
var maxWeatherKey = _.max(_.keys(window.demo.weather), function(state){
  return window.demo.weather[state];
});

var minWeather = window.demo.weather[minWeatherKey];
var maxWeather = window.demo.weather[maxWeatherKey];

var weatherColorScale = d3.scale.quantize()
  .domain([minWeather, maxWeather])
  .range(d3.range(9)
  .map(function(i) { return 8 - i; }));


var blues = [
[247,251,255],
[222,235,247],
[198,219,239],
[158,202,225],
[107,174,214],
[66,146,198],
[33,113,181],
[8,81,156],
[8,48,107]]

var reds = [
[255,245,240],
[254,224,210],
[252,187,161],
[252,146,114],
[251,106,74],
[239,59,44],
[203,24,29],
[165,15,21],
[103,0,13],
]

var numberFormatter = d3.format(',.0f');
var tooltipTemplate = _.template('<span class="population"><%= population %></span><span class="stateName"><%= name %></span>');

d3.json('http://forio.com/tools/contour/geo/maps/us-all.json', function (us) {
  new Contour({
    el: '.myBivariateMap',
    tooltip: {
      formatter: function (d, i, j) {
        return tooltipTemplate({ name: d.properties.name, population: numberFormatter(flowPerPop[d.id]) });
      }
    }
  })
  .geo()
  .USMap(us, {
    fill: function(d) {
      var popIdx = popColorScale(flowPerPop[d.id]);
      var weatherIdx = weatherColorScale(window.demo.weather[d.id]);
      var popColors = blues[popIdx];
      var weatherColors = reds[weatherIdx];

      if (!popIdx && popIdx !== 0) {
        return d3.rgb(0,0,0);
      }
      color = colorAddition(weatherColors, popColors);

      return d3.rgb(color[0], color[1], color[2]);
    }
  })
  .smallStatesCallouts()
  .tooltip()
  .render();
});

var colorAddition = function(colorOne, colorTwo) {
  var colors = []
  _.each(colorOne, function(el, idx){
    colors.push((colorOne[idx] + colorTwo[idx]) / 2);
  })
  return colors;
}
</script>
